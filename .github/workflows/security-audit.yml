name: Security Audit

on:
  push:
    branches: [main, develop]
    paths:
      - "pyproject.toml"
      - "requirements*.txt"
      - "apps/frontend/package*.json"
      - "apps/web/package*.json"
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œ
    - cron: "0 0 * * *"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ==========================================
  # Python ä¾èµ–å®‰å…¨å®¡è®¡
  # ==========================================
  python-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Run pip-audit (dry-run mode)
        run: |
          # ä½¿ç”¨ dry-run æ¨¡å¼ï¼Œä¸å®é™…å®‰è£…ä¾èµ–ï¼Œåªæ£€æŸ¥ pyproject.toml
          pip-audit --requirement <(pip-compile --quiet --output-file=- pyproject.toml 2>/dev/null || echo "") \
            --desc on --format markdown --output audit-python.md 2>/dev/null || \
          pip-audit --local --desc on --format markdown --output audit-python.md || \
          echo "# Python Audit\n\nNo vulnerabilities found or scan skipped." > audit-python.md
          cat audit-python.md

      - name: Upload Python audit report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: python-audit-report
          path: audit-python.md
          retention-days: 30

  # ==========================================
  # npm ä¾èµ–å®‰å…¨å®¡è®¡ (Frontend)
  # ==========================================
  npm-audit-frontend:
    name: npm Audit (Frontend)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > ../../audit-frontend.json || true

      - name: Upload Frontend audit report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: frontend-audit-report
          path: audit-frontend.json
          retention-days: 30

  # ==========================================
  # npm ä¾èµ–å®‰å…¨å®¡è®¡ (Admin)
  # ==========================================
  npm-audit-admin:
    name: npm Audit (Admin)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > ../../audit-admin.json || true

      - name: Upload Admin audit report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: admin-audit-report
          path: audit-admin.json
          retention-days: 30

  # ==========================================
  # å®‰å…¨æŠ¥å‘Šæ±‡æ€»
  # ==========================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [python-audit, npm-audit-frontend, npm-audit-admin]
    if: always()
    steps:
      - name: Download all audit reports
        uses: actions/download-artifact@v7
        with:
          path: reports

      - name: Generate summary
        run: |
          echo "## ğŸ”’ Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Backend | ${{ needs.python-audit.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (npm) | ${{ needs.npm-audit-frontend.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Admin (npm) | ${{ needs.npm-audit-admin.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ Detailed reports are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
