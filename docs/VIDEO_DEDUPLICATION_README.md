# è§†é¢‘ç‰‡æ®µå»é‡åŠŸèƒ½è¯´æ˜

## é—®é¢˜èƒŒæ™¯

æ­Œæ›²ä¸­ç»å¸¸æœ‰é‡å¤çš„æ­Œè¯ï¼ˆç‰¹åˆ«æ˜¯å‰¯æ­Œéƒ¨åˆ†ï¼‰ï¼Œå¦‚æœæ¯æ¬¡éƒ½ä½¿ç”¨ç›¸åŒçš„è§†é¢‘ç‰‡æ®µï¼Œä¼šå¯¼è‡´ï¼š
- âŒ è§‚çœ‹ä½“éªŒå•è°ƒ
- âŒ é‡å¤çš„ç”»é¢é™ä½è§†è§‰å¸å¼•åŠ›
- âŒ å¤±å»è§†é¢‘æ··å‰ªçš„å¤šæ ·æ€§

**ç¤ºä¾‹**:
```
ç¬¬1æ¬¡å‰¯æ­Œ: "I can't lose nothing twice" â†’ è§†é¢‘ç‰‡æ®µA
ç¬¬2æ¬¡å‰¯æ­Œ: "I can't lose nothing twice" â†’ è§†é¢‘ç‰‡æ®µAï¼ˆé‡å¤ï¼ï¼‰
ç¬¬3æ¬¡å‰¯æ­Œ: "I can't lose nothing twice" â†’ è§†é¢‘ç‰‡æ®µAï¼ˆé‡å¤ï¼ï¼‰
```

## è§£å†³æ–¹æ¡ˆ

### å®ç°åŸç†

å®ç°äº†**å…¨å±€ç‰‡æ®µè¿½è¸ªä¸æ™ºèƒ½é€‰æ‹©æœºåˆ¶**ï¼š

1. **è¿½è¸ªå·²ä½¿ç”¨ç‰‡æ®µ**: ä½¿ç”¨ `_used_segments` å­—å…¸è®°å½•æ¯ä¸ªè§†é¢‘ç‰‡æ®µçš„ä½¿ç”¨æ¬¡æ•°
2. **å¢åŠ å€™é€‰æ•°é‡**: ä» 3 ä¸ªå€™é€‰å¢åŠ åˆ° 10 ä¸ªï¼Œæä¾›æ›´å¤šé€‰æ‹©ç©ºé—´
3. **æ™ºèƒ½ä¼˜å…ˆçº§æ’åº**:
   - ä¼˜å…ˆé€‰æ‹©æœªä½¿ç”¨è¿‡çš„ç‰‡æ®µ
   - å¦‚æœéƒ½ä½¿ç”¨è¿‡ï¼Œé€‰æ‹©ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„
   - ç›¸åŒä½¿ç”¨æ¬¡æ•°æ—¶ï¼Œé€‰æ‹©è¯„åˆ†æ›´é«˜çš„

### ä»£ç å®ç°

#### 1. è¿½è¸ªæœºåˆ¶ (`timeline_builder.py:41`)

```python
class TimelineBuilder:
    def __init__(self) -> None:
        # ... å…¶ä»–åˆå§‹åŒ–
        # è¿½è¸ªå·²ä½¿ç”¨çš„è§†é¢‘ç‰‡æ®µï¼škey = (video_id, start_ms), value = ä½¿ç”¨æ¬¡æ•°
        self._used_segments: dict[tuple[str, int], int] = {}
```

#### 2. å¢åŠ å€™é€‰æ•°é‡ (`timeline_builder.py:75`)

```python
# è·å–æ›´å¤šå€™é€‰ç‰‡æ®µä»¥æ”¯æŒå»é‡é€‰æ‹©ï¼ˆåŸæ¥æ˜¯3ä¸ªï¼Œç°åœ¨å¢åŠ åˆ°10ä¸ªï¼‰
candidates = await self._get_candidates(text, limit=10)
```

#### 3. æ™ºèƒ½é€‰æ‹© (`timeline_builder.py:79`)

```python
# é€‰æ‹©æœªä½¿ç”¨æˆ–ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„ç‰‡æ®µ
selected_candidates = self._select_diverse_candidates(normalized, limit=3)
```

#### 4. æ ‡è®°å·²ä½¿ç”¨ (`timeline_builder.py:82-85`)

```python
# æ ‡è®°ç¬¬ä¸€ä¸ªå€™é€‰ç‰‡æ®µä¸ºå·²ä½¿ç”¨ï¼ˆæ¸²æŸ“æ—¶é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªï¼‰
if selected_candidates:
    first = selected_candidates[0]
    segment_key = (str(first.get("source_video_id")), int(first.get("start_time_ms", 0)))
    self._used_segments[segment_key] = self._used_segments.get(segment_key, 0) + 1
```

#### 5. æ’åºç­–ç•¥ (`timeline_builder.py:201-249`)

```python
def _select_diverse_candidates(
    self, candidates: list[dict[str, int | float | str]], limit: int
) -> list[dict[str, int | float | str]]:
    """
    ä»å€™é€‰åˆ—è¡¨ä¸­é€‰æ‹©å¤šæ ·åŒ–çš„ç‰‡æ®µï¼Œé¿å…é‡å¤ä½¿ç”¨ç›¸åŒçš„è§†é¢‘ç‰‡æ®µã€‚

    ç­–ç•¥ï¼š
    1. ä¼˜å…ˆé€‰æ‹©æœªä½¿ç”¨è¿‡çš„ç‰‡æ®µ
    2. å¦‚æœæ‰€æœ‰ç‰‡æ®µéƒ½ä½¿ç”¨è¿‡ï¼Œé€‰æ‹©ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„
    3. ä¿æŒåŸå§‹çš„ç›¸å…³æ€§æ’åºï¼ˆscoreè¶Šé«˜è¶Šé å‰ï¼‰
    """
    # ä¸ºæ¯ä¸ªå€™é€‰ç‰‡æ®µè®¡ç®—ä½¿ç”¨æ¬¡æ•°
    candidates_with_usage = []
    for candidate in candidates:
        video_id = str(candidate.get("source_video_id", ""))
        start_ms = int(candidate.get("start_time_ms", 0))
        segment_key = (video_id, start_ms)
        usage_count = self._used_segments.get(segment_key, 0)

        candidates_with_usage.append({
            "candidate": candidate,
            "usage_count": usage_count,
            "score": float(candidate.get("score", 0.0)),
        })

    # æ’åºç­–ç•¥ï¼š
    # 1. ä½¿ç”¨æ¬¡æ•°å°‘çš„ä¼˜å…ˆï¼ˆusage_countå‡åºï¼‰
    # 2. ç›¸åŒä½¿ç”¨æ¬¡æ•°æ—¶ï¼Œscoreé«˜çš„ä¼˜å…ˆï¼ˆscoreé™åºï¼‰
    candidates_with_usage.sort(key=lambda x: (x["usage_count"], -x["score"]))

    # æå–å€™é€‰ç‰‡æ®µå¹¶é™åˆ¶æ•°é‡
    selected = [item["candidate"] for item in candidates_with_usage[:limit]]

    return selected
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

è¿è¡Œ `test_deduplication.py`:

```bash
.venv/bin/python test_deduplication.py
```

### æµ‹è¯•åœºæ™¯

æ¨¡æ‹Ÿä¸€é¦–åŒ…å«3æ¬¡é‡å¤å‰¯æ­Œçš„æ­Œæ›²ï¼š

```
Verse 1: I'm walking down the street
Chorus: I can't lose nothing twice        â† ç¬¬1æ¬¡
Verse 2: The pain is real tonight
Chorus: I can't lose nothing twice        â† ç¬¬2æ¬¡ï¼ˆé‡å¤ï¼‰
Bridge: Standing with the weight
Chorus: I can't lose nothing twice        â† ç¬¬3æ¬¡ï¼ˆé‡å¤ï¼‰
Outro: Finally free at last
```

### æµ‹è¯•ç»“æœ

```
âœ… å»é‡ç»“æœåˆ†æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š é‡å¤æ­Œè¯ 'I can't lose nothing twice' å‡ºç°æ¬¡æ•°: 3

ğŸ¥ æ¯æ¬¡é‡å¤ä½¿ç”¨çš„è§†é¢‘ç‰‡æ®µ:
   ç¬¬1æ¬¡å‡ºç°:
      - è§†é¢‘ID: 691aefd63816c1807e14aa62
      - æ—¶é—´èŒƒå›´: 395799ms - 396799ms

   ç¬¬2æ¬¡å‡ºç°:
      - è§†é¢‘ID: 691ac6f93816c1807e1492cf    â† ä¸åŒçš„è§†é¢‘
      - æ—¶é—´èŒƒå›´: 134833ms - 135833ms

   ç¬¬3æ¬¡å‡ºç°:
      - è§†é¢‘ID: 691ac6e9fb5cdc6dfc0ca433    â† åˆæ˜¯ä¸åŒçš„è§†é¢‘
      - æ—¶é—´èŒƒå›´: 134833ms - 135833ms

âœ… æ²¡æœ‰é‡å¤ä½¿ç”¨çš„ç‰‡æ®µï¼æ¯æ¬¡å‰¯æ­Œéƒ½ä½¿ç”¨äº†ä¸åŒçš„è§†é¢‘ç‰‡æ®µã€‚

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ å»é‡æ•ˆæœæ‘˜è¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»æ­Œè¯è¡Œæ•°: 7
ç‹¬ç«‹è§†é¢‘ç‰‡æ®µæ•°: 7
é‡å¤ä½¿ç”¨çš„ç‰‡æ®µæ•°: 0
å»é‡ç‡: 100.0%

ğŸ‰ æµ‹è¯•é€šè¿‡ï¼é‡å¤æ­Œè¯æˆåŠŸä½¿ç”¨äº†ä¸åŒçš„è§†é¢‘ç‰‡æ®µã€‚
```

## æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ

| æ­Œè¯å‡ºç°æ¬¡æ•° | ä½¿ç”¨çš„è§†é¢‘ç‰‡æ®µ |
|------------|-------------|
| ç¬¬1æ¬¡å‰¯æ­Œ | è§†é¢‘A (395799ms) |
| ç¬¬2æ¬¡å‰¯æ­Œ | è§†é¢‘A (395799ms) â† é‡å¤ï¼ |
| ç¬¬3æ¬¡å‰¯æ­Œ | è§†é¢‘A (395799ms) â† é‡å¤ï¼ |

**é—®é¢˜**: ç›¸åŒçš„ç”»é¢é‡å¤3æ¬¡ï¼Œè§‚çœ‹ä½“éªŒå•è°ƒ

### ä¿®å¤å âœ…

| æ­Œè¯å‡ºç°æ¬¡æ•° | ä½¿ç”¨çš„è§†é¢‘ç‰‡æ®µ |
|------------|-------------|
| ç¬¬1æ¬¡å‰¯æ­Œ | è§†é¢‘A (691aefd6..., 395799ms) |
| ç¬¬2æ¬¡å‰¯æ­Œ | è§†é¢‘B (691ac6f9..., 134833ms) âœ… ä¸åŒ |
| ç¬¬3æ¬¡å‰¯æ­Œ | è§†é¢‘C (691ac6e9..., 134833ms) âœ… ä¸åŒ |

**æ•ˆæœ**: æ¯æ¬¡å‰¯æ­Œä½¿ç”¨ä¸åŒçš„è§†é¢‘ç‰‡æ®µï¼Œç”»é¢ä¸°å¯Œå¤šæ ·

## å·¥ä½œæµç¨‹

```
æ­Œè¯1: "Hello world"
   â†“
æœç´¢ API â†’ 10ä¸ªå€™é€‰ç‰‡æ®µ
   â†“
é€‰æ‹©æœªä½¿ç”¨çš„ç‰‡æ®µA â†’ æ ‡è®°ä¸ºå·²ä½¿ç”¨(1æ¬¡)
   â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ­Œè¯2: "Hello world" (é‡å¤)
   â†“
æœç´¢ API â†’ 10ä¸ªå€™é€‰ç‰‡æ®µ (åŒ…å«ç‰‡æ®µA)
   â†“
ç‰‡æ®µAå·²ä½¿ç”¨1æ¬¡ â†’ æ’åœ¨åé¢
ç‰‡æ®µBæœªä½¿ç”¨     â†’ ä¼˜å…ˆé€‰æ‹© âœ…
   â†“
é€‰æ‹©ç‰‡æ®µB â†’ æ ‡è®°ä¸ºå·²ä½¿ç”¨(1æ¬¡)
   â†“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ­Œè¯3: "Hello world" (å†æ¬¡é‡å¤)
   â†“
æœç´¢ API â†’ 10ä¸ªå€™é€‰ç‰‡æ®µ (åŒ…å«ç‰‡æ®µAã€B)
   â†“
ç‰‡æ®µAå·²ä½¿ç”¨1æ¬¡ â†’ æ’åœ¨åé¢
ç‰‡æ®µBå·²ä½¿ç”¨1æ¬¡ â†’ æ’åœ¨åé¢
ç‰‡æ®µCæœªä½¿ç”¨     â†’ ä¼˜å…ˆé€‰æ‹© âœ…
   â†“
é€‰æ‹©ç‰‡æ®µC â†’ æ ‡è®°ä¸ºå·²ä½¿ç”¨(1æ¬¡)
```

## ä¼˜åŠ¿

### 1. æå‡è§‚çœ‹ä½“éªŒ
- âœ… é¿å…é‡å¤ç”»é¢
- âœ… å¢åŠ è§†è§‰å¤šæ ·æ€§
- âœ… ä¿æŒè§‚ä¼—æ³¨æ„åŠ›

### 2. æ™ºèƒ½é™çº§
å¦‚æœå€™é€‰ç‰‡æ®µä¸è¶³ï¼Œç³»ç»Ÿä¼šæ™ºèƒ½é€‰æ‹©ï¼š
- ä¼˜å…ˆä½¿ç”¨æœªä½¿ç”¨çš„ç‰‡æ®µ
- æ— æœªä½¿ç”¨ç‰‡æ®µæ—¶ï¼Œé€‰æ‹©ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„
- ä¿è¯æ€»èƒ½é€‰å‡ºæœ€ä½³å€™é€‰

### 3. ä¿æŒç›¸å…³æ€§
åœ¨å»é‡çš„åŒæ—¶ï¼Œä»ç„¶ä¼˜å…ˆè€ƒè™‘ç‰‡æ®µçš„ç›¸å…³æ€§è¯„åˆ†ï¼ˆscoreï¼‰

### 4. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨å­—å…¸è¿½è¸ªï¼ŒO(1)æŸ¥æ‰¾å¤æ‚åº¦
- åªåœ¨ build æ—¶è¿½è¸ªï¼Œæ¯æ¬¡æ„å»ºç‹¬ç«‹
- å†…å­˜å ç”¨ä½ï¼ˆåªè®°å½• video_id + start_msï¼‰

## é…ç½®

### è°ƒæ•´å€™é€‰æ•°é‡

å¦‚æœéœ€è¦æ›´å¼ºçš„å»é‡èƒ½åŠ›ï¼Œå¯ä»¥å¢åŠ å€™é€‰æ•°é‡ï¼š

```python
# timeline_builder.py:75
candidates = await self._get_candidates(text, limit=15)  # ä»10å¢åŠ åˆ°15
```

### è°ƒæ•´è¿”å›æ•°é‡

å¦‚æœéœ€è¦æä¾›æ›´å¤šå¤‡é€‰ç‰‡æ®µï¼š

```python
# timeline_builder.py:79
selected_candidates = self._select_diverse_candidates(normalized, limit=5)  # ä»3å¢åŠ åˆ°5
```

## ç›‘æ§

ç³»ç»Ÿä¼šåœ¨æ—¥å¿—ä¸­è¾“å‡ºå»é‡ä¿¡æ¯ï¼š

```log
[info] timeline_builder.diversity_selection
  total_candidates=10
  selected_count=3
  first_usage_count=1
  message="é€‰æ‹©ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„ç‰‡æ®µï¼ˆå·²ä½¿ç”¨1æ¬¡ï¼‰"
```

## ç›¸å…³æ–‡ä»¶

- `src/pipelines/matching/timeline_builder.py:41` - è¿½è¸ªæœºåˆ¶
- `src/pipelines/matching/timeline_builder.py:201-249` - æ™ºèƒ½é€‰æ‹©é€»è¾‘
- `test_deduplication.py` - æµ‹è¯•è„šæœ¬
- `VIDEO_DEDUPLICATION_README.md` - æœ¬æ–‡æ¡£

## æ›´æ–°è®°å½•

- **2025-11-18**: åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
  - å®ç°å…¨å±€ç‰‡æ®µè¿½è¸ª
  - æ™ºèƒ½ä¼˜å…ˆçº§æ’åº
  - 100% å»é‡ç‡æµ‹è¯•é€šè¿‡
