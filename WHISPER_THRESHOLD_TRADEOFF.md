# Whisper no_speech_threshold 阈值权衡说明

## 问题背景

`no_speech_prob` 阈值不仅影响 Whisper 过滤片段的数量，还会影响 **Whisper 内部的分句策略**。

## 实测发现

### 阈值对不同歌曲的影响

| 阈值 | tom.mp3 (无前奏) | 吞噬星空 (12秒前奏) | 问题 |
|------|-----------------|-------------------|------|
| 0.6  | 48片段，分句细致 | 53片段，**第一句从39.9s开始** | ❌ 丢失前27.9秒歌词 |
| 0.7  | 48片段，分句细致 | 64片段，**第一句从39.9s开始** | ❌ 丢失前27.9秒歌词 |
| 0.75 | 48片段，分句细致 | 51片段，**第一句从39.9s开始** | ❌ 丢失前27.9秒歌词 |
| **0.8** | **26片段，句子合并** | **106片段，第一句从12.0s开始** | ✅ 准确识别，但无前奏歌曲分句较粗 |
| 0.85 | 48片段，分句细致 | 54片段，第一句从12.0s开始 | ⚠️ 片段数较少 |
| 0.9  | 48片段，分句细致 | 60片段，第一句从12.0s开始 | ⚠️ 片段数较少 |

### 具体表现差异

#### 阈值 0.6 (旧版本)
```srt
1. talking to the moon 放不下的理由
2. 是不是会担心 变成一只野兽
3. walking on the roof 微信跳的节奏
4. 是不是会暂停 在世界的尽头
5. 浸泡在时空深的频率
6. 单纯想要呼吸 讨厌云里雾离
```
✅ 每句独立，画面丰富
❌ 长前奏歌曲丢失开头人声

#### 阈值 0.8 (当前版本)
```srt
1. talking to the moon 放不下的理由
2. 是不是会担心 变成一只野兽
3. walking on the roof 微信跳的节奏
4. 是不是会暂停 在世界的尽头
5. 浸泡在时空深的频率 单纯想要呼吸 讨厌云里雾里  ← 3句合并
6. 触摸在被遗忘的抽屉 你曾经的手笔 写着信口不一  ← 3句合并
```
⚠️ 多句合并，画面变化减少
✅ 长前奏歌曲准确识别开头人声（12.0s）

## 根本原因

**Whisper 模型内部行为**：`no_speech_prob` 阈值不仅用于过滤片段，还会影响模型的分句边界判定。

- **低阈值 (0.6-0.75)**：模型更激进地拆分句子，但会将前奏后的弱人声误判为非语音
- **高阈值 (0.8-0.9)**：模型保留更多片段，正确识别弱人声，但倾向于合并相邻句子

这是 Whisper 模型的固有特性，**不在我们的控制范围内**。

## 当前选择：阈值 0.8

### 优先级考虑

1. **准确性 > 丰富度**：丢失开头歌词是致命错误，而句子合并只是体验下降
2. **适用性**：带前奏的歌曲很常见，必须保证准确识别
3. **可调整性**：用户可以针对特定歌曲调整阈值

### 权衡决策

✅ **保证**：长前奏歌曲准确识别开头人声（吞噬星空从12.0s开始，而非39.9s）
✅ **保证**：生成足够多的片段（吞噬星空106个片段）
⚠️ **代价**：无前奏歌曲的句子会合并（tom.mp3 从48片段降到26片段）

## 用户调整建议

### 场景1：处理无前奏歌曲，希望画面更丰富
```env
WHISPER_NO_SPEECH_THRESHOLD=0.6
```
- ✅ 句子拆分细致，画面变化频繁
- ❌ **警告**：带前奏歌曲会丢失开头人声

### 场景2：处理带长前奏歌曲（推荐默认）
```env
WHISPER_NO_SPEECH_THRESHOLD=0.8
```
- ✅ 准确识别前奏后的人声
- ✅ 生成丰富的片段数
- ⚠️ 无前奏歌曲句子可能合并

### 场景3：平衡选择（实验性）
```env
WHISPER_NO_SPEECH_THRESHOLD=0.75
```
- ⚠️ 可能仍然丢失前奏后的弱人声
- ⚠️ 需要针对具体歌曲测试

## 未来改进方向

1. **自适应阈值**：根据音频特征自动选择合适的阈值
2. **后处理拆分**：在 Whisper 输出后，使用 NLP 技术拆分合并的长句
3. **混合策略**：前奏部分使用高阈值，主歌部分使用低阈值
4. **用户反馈**：收集更多歌曲的测试数据，优化默认阈值

## 技术细节

### 代码位置
- 配置定义：`src/infra/config/settings.py` - `whisper_no_speech_threshold`
- 过滤逻辑：`src/pipelines/lyrics_ingest/transcriber.py` - `_filter_segments()`
- 环境变量：`.env` - `WHISPER_NO_SPEECH_THRESHOLD`

### 相关功能
- **自动跳过前奏**：`_detect_vocal_start()` 使用 RMS 能量分析检测人声起点
- **时间戳调整**：自动补偿跳过的前奏时长，确保字幕对齐

## 参考资料

- 测试报告：`test_results_summary.md`
- 测试脚本：`scripts/dev/test_threshold_optimal.py`
- Whisper 文档：https://github.com/openai/whisper
