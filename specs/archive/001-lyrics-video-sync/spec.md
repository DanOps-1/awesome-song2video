# 功能规格：歌词语义混剪视频

**特性分支**：`001-lyrics-video-sync`  
**创建日期**：2025-11-11  
**状态**：Draft  
**输入**：用户希望“输入一首歌并利用 TwelveLabs SDK 将歌词语义匹配到视频片段，输出逐句同步的混剪视频；API Key 与 Index ID 已在安全配置中提供。”

> 所有内容必须以简体中文撰写，且描述需直接映射到可测试的异步实现。禁止只写概念或英文引用。

## 用户场景与测试（必填）

> 用户故事需按重要性排序，并满足“独立可上线、独立可测试”的切片标准。

### 用户故事 1 - 自动生成歌词语义时间线（优先级：P1）

创作者在平台上传歌曲音频或选择歌曲 ID，系统自动提取歌词文本与时间戳，调用 TwelveLabs 文本索引能力，为每句歌词推荐一组与语义最贴近的视频片段，并生成初版混剪时间线供预览。

**优先级理由**：没有自动匹配与时间线，整个混剪工作无法启动，是价值闭环的第一步。

**独立测试方式**：提供一份包含 10 句歌词的歌曲输入，核对输出的时间线 JSON 是否含每句歌词、推荐片段 ID、置信度与开始/结束时间，并验证可在 2 分钟内生成。

**验收场景**：

1. **Given** 用户已上传合法歌曲，**When** 触发“生成混剪方案”，**Then** 系统在 120 秒内返回含所有歌词句的推荐片段列表。
2. **Given** TwelveLabs 返回多个候选片段，**When** 系统构建时间线，**Then** 每句歌词至少选取一条匹配且记录来源视频与时间范围。

---

### 用户故事 2 - 逐句校对与替换片段（优先级：P2）

策划人员逐句审阅推荐片段，能够查看歌词、预览当前画面、查看置信度，并可重新触发语义检索或手动替换为其他素材，同时调整片段时长，确保画面节奏与歌词含义一致。

**优先级理由**：自动匹配可能存在语义偏差，需要人工复核才能保证最终质量。

**独立测试方式**：在时间线界面选择任意一句歌词，替换为新的候选片段并调整持续时间，确认 UI 能实时刷新播放预览、更新元数据并记录变更。

**验收场景**：

1. **Given** 已生成的时间线，**When** 用户点击某句歌词，**Then** 系统展示当前片段、候选列表与置信度。
2. **Given** 用户选择重新检索，**When** 输入新的语义提示，**Then** 系统展示不少于 3 条新的候选片段供选择。
3. **Given** 用户手动拖拽时间范围，**When** 保存改动，**Then** 时间线更新并记录改动日志供撤销。

---

### 用户故事 3 - 导出歌词同步混剪视频（优先级：P3）

内容运营在确认时间线后，发起渲染流程，系统根据歌词顺序与已选片段自动拼接视频，生成带歌词字幕的 H.264/1080p.mp4，允许下载或推送到下游渠道，并生成对账日志（所用视频、来源、时间段）。

**优先级理由**：最终交付物是视频文件，没有出口就无法真实上线。

**独立测试方式**：使用 30 句歌词的时间线触发导出，验证渲染耗时、输出格式、字幕同步情况与日志文件齐备。

**验收场景**：

1. **Given** 时间线已锁定，**When** 点击“导出混剪”，**Then** 系统在 10 分钟内生成 1080p MP4 与字幕文件。
2. **Given** 导出完成，**When** 用户下载结果，**Then** 视频中每句歌词字幕与画面切换延迟 < 0.5 秒。
3. **Given** 视频使用了多个素材，**When** 查看导出日志，**Then** 列出所有原创视频 ID、起止时间与对应歌词行。

---

[如需更多故事，保持相同结构]

### 边界条件

- 当 TwelveLabs 索引未返回满足阈值的片段时，系统需提供默认 B-roll 素材或允许用户上传自有素材以填补空缺。
- 当歌词缺少时间戳时，系统需通过语音识别或均分策略生成临时时间标记，再提示用户复核。
- 当 API Key、Index ID 配置缺失或配额耗尽时，系统需阻止生成流程并提示管理员补全配置。

## 需求（必填）

### 功能性需求

- **FR-001**：系统必须支持上传音频/歌词文本或引用歌曲元数据，并在 30 秒内完成歌词解析与时间戳生成。
- **FR-002**：系统必须调用 TwelveLabs SDK（索引 ID：6911aaadd68fb776bc1bd8e7）为每句歌词检索不少于 3 个语义匹配片段，并返回置信度与起止时间。
- **FR-003**：系统必须根据歌词顺序构建可编辑时间线，每个节点包含歌词文本、指向视频片段的引用、持续时长与置信度。
- **FR-004**：用户必须能够对任意节点执行重新检索、手动替换素材、调整时间范围与添加备注，所有更改需写入审计日志。
- **FR-005**：系统必须提供混剪预览，支持逐句回放与整体播放，画面与歌词字幕延迟不超过 500ms。
- **FR-006**：系统必须支持批量渲染（至少同时排队 3 个任务），导出 H.264/1080p 视频、SRT 字幕与 JSON 结构化日志。
- **FR-007**：系统必须将 TwelveLabs API Key、索引配置与渲染参数存放在安全配置服务中，禁止写入规格、日志或前端代码，并对调用失败提供可追踪的错误码。

### 核心实体（如涉及数据模型）

- **SongMixRequest**：一次混剪任务的顶层实体，字段包含歌曲 ID、歌词文本、解析状态、创建人、生成时间、导出状态、错误码集合。
- **LyricLine**：单句歌词及其时间范围，属性含行号、原文、翻译（如有）、开始/结束时间、匹配片段引用、人工备注、状态（待确认/已确认）。
- **VideoSegmentMatch**：TwelveLabs 返回的候选片段，记录来源视频 ID、起止时间、置信度、主题标签、检索提示语，支持与 LyricLine 建立一对多关系。

## 成功标准（必填）

> 指标需可度量、与技术无关，并能在验收时客观判断通过/未通过。

- **SC-001**：90% 的歌词句子在首次自动生成时即可获得置信度 ≥0.6 的视频匹配，且生成耗时 ≤2 分钟/首歌。
- **SC-002**：策划人员在不超过 20 分钟内能够完成 30 句歌词的审核与替换，界面响应时间 P95 ≤ 1 秒。
- **SC-003**：导出的视频字幕与画面切换延迟平均 ≤0.3 秒，延迟最大值 ≤0.5 秒（抽样 5 条歌曲验证）。
- **SC-004**：混剪交付周期较全手动流程缩短 ≥60%，并在上线后两周内支撑至少 10 个项目无阻塞完成。

## 假设与依赖

- TwelveLabs SDK 可在当前网络与配额条件下稳定调用，索引 ID `6911aaadd68fb776bc1bd8e7` 已预加载合规素材。
- API Key `tlk_***` 仅保存在服务端安全存储中，本规格与日志不记录明文，客户端通过受控后端代理访问。
- 渲染所需的基础素材（被检索的视频）已获得版权授权，可在内部媒资库读取。
- 最终导出格式默认为 1080p/25fps，如需其他规格将在后续计划阶段确认。
