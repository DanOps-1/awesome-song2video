# 功能规格：渲染 Worker 并行异步裁剪

**特性分支**：`001-async-render`  
**创建日期**：2025-11-19  
**状态**：Draft  
**输入**：用户描述 “我需要把这个做成并行异步处理”

> 所有内容必须以简体中文撰写，且描述需直接映射到可测试的异步实现。禁止只写概念或英文引用。若涉及媒资下载/渲染，请明确是否按需截取片段、如何清理临时文件及记录对齐指标；若涉及歌词输入，请说明分句策略与时间窗分配。若涉及查询改写或片段去重，请说明改写策略（包含多次尝试、降级路径）、启停配置（如 `QUERY_REWRITE_ENABLED`）以及片段多样性/去重率的监控方式。

## 用户场景与测试（必填）

> 用户故事需按重要性排序，并满足“独立可上线、独立可测试”的切片标准。

### 用户故事 1 - 并行裁剪缩短渲染时间（优先级：P1）

渲染调度服务在收到锁定歌词行后，启动渲染任务。系统需要一次性为 50+ 段歌词生成剪辑，如果逐个串行下载，单曲渲染会拖到 40 分钟以上，运营无法及时向甲方交付。期望渲染 Worker 在获取剪辑列表后，能并行（受限于可配置的并发上限）触发多段 HLS 拉流与裁剪，缩短整体等待，同时保持按需截取片段、不落本地全量文件。

**优先级理由**：直接影响交付 SLA，是线上投诉的根因，若不解决，会阻塞歌词混剪方案的验收。

**独立测试方式**：在 staging 使用 60 行歌词的真实请求，比较开启并行前后的 `render_worker.completed` 耗时与 `clip_*` 数量；观察日志确认同一时间多段 clip 正在处理且持续保持在配置上限以下。

**验收场景**：

1. **Given** 渲染任务含 50 段剪辑，**When** render worker 启动，**Then** 系统一次性并发拉起 N（`render_clip_concurrency`）条裁剪并在 10 分钟内完成全部片段。
2. **Given** 并发执行中任一 clip 裁剪耗时较长，**When** 其他 clip 已完成，**Then** worker 继续分配空闲配额给剩余片段，无需等待最慢的一条结束才开始下一条。

---

### 用户故事 2 - 可观测与限流控制（优先级：P2）

运维需要根据 CDN 带宽、FFmpeg 资源和 TwelveLabs API 配额来调整裁剪并发。系统需暴露配置项、运行期指标和告警钩子，以便及时收敛并发或排查异常。

**优先级理由**：并行策略若缺乏可控性，容易压垮外部 API 或拖垮本机 IO，必须同步上线监控与开关。

**独立测试方式**：调低 `render_clip_concurrency` 并再次提交渲染，确认日志与指标中出现新的配置值；在 Grafana/Loki 中检查 `twelvelabs.video_clip` 的同时执行数是否符合配置；模拟 CDN 报错时确认降级策略与告警。

**验收场景**：

1. **Given** 管理员修改并发配置，**When** 新任务启动，**Then** 实际拉起的并发数量与配置一致，并在日志/指标中可见。
2. **Given** 某 clip 下载失败次数超过阈值，**When** 系统触发重试或降级，**Then** 记录结构化日志并把失败次数计入 metrics，方便 SRE 观测。

---

### 用户故事 3 - 容错与回退（优先级：P3）

当某些 clip 需要反复重试或 CDN 临时不可用时，系统要自动切换到本地素材或标记缺失片段，避免整条渲染任务被卡死。并行模型也要确保部分任务失败不会拖垮整个 worker。

**优先级理由**：虽然频率低，但一旦发生会导致全部任务重跑，影响 SLA；需要在本次重构时明确流程。

**独立测试方式**：人为让特定视频 ID 返回 404，观察 worker 是否及时切换到本地文件或记录失败并继续后续片段；确保最终渲染结果包含可追踪的缺失记录。

**验收场景**：

1. **Given** 某视频只在本地有全量文件，**When** HLS 拉流失败，**Then** worker 自动切到本地截取并继续并行执行剩余任务。
2. **Given** 某 clip 重试后仍失败，**When** 达到最大重试次数，**Then** 任务写入失败明细并继续渲染其他片段，最终输出中包含失败摘要供运营补录。

---

[如需更多故事，保持相同结构]

### 边界条件

- 当全部 clip 总数小于并发上限时，系统不应额外创建空闲任务，需即时标记完成并关闭线程池。
- 当渲染任务存在重复视频 ID 时，需支持同源片段共用 HLS 会话或在缓存命中后跳过重复 retrieve 请求，防止 API 被多次调用。
- 当 FFmpeg 不存在或被回收时，worker 需要捕获异常并把任务状态标记为失败，同时释放并发配额。
- 当配置的并发值高于机器核数或网络限制时，需要记录警告并自动降级到安全阈值，确保 worker 不会因系统资源耗尽而崩溃。

## 需求（必填）

### 功能性需求

- **FR-001**：渲染 Worker 必须在 `_extract_clips` 阶段按配置的 `render_clip_concurrency` 并发数，将每个 `RenderLine` 转换为独立的异步裁剪任务，且默认值需在配置文件中可修改（默认 4）。
- **FR-002**：系统必须为每个裁剪任务实现统一的重试策略（至少 2 次）与指数退避，且在超过阈值后自动切换到本地视频文件或标记缺失。
- **FR-003**：worker 必须维护任务级调度队列，保证同一渲染任务内的所有裁剪都被消费；当某任务失败时需释放并发配额继续调度下一条。
- **FR-004**：系统必须在结构化日志中输出 `twelvelabs.video_clip` 并新增字段 `clip_task_id`、`clip_status`、`parallel_slot`，用于排查并行行为，同时带上 `trace_id`。
- **FR-005**：渲染任务完成时必须持久化裁剪阶段的统计数据（平均下载耗时、失败次数、峰值并发）到 `RenderJob.metrics.render.clip_stats`，供后续分析。
- **FR-006**：当 CDN/HLS 无法访问且本地文件缺失时，worker 必须在渲染结果中插入占位片段（例如静态黑屏）并在最终报告中记录缺失明细，防止输出中出现时间轴断裂。
- **FR-007**：系统必须暴露 Prometheus 指标（进行中 clip 数、成功/失败率、平均耗时），并在渲染队列深度指标中加入裁剪阶段的等待时间，以便 SRE 监控。
- **FR-008**：当并发配置或回退策略被更新时，系统需在无需重启 worker 的情况下热加载配置（通过 Redis/环境变量轮询或管理指令），确保部署不中断。

### 核心实体（如涉及数据模型）

- **RenderJob**：表示一次完整的渲染流程，关键属性包含 `id`、`mix_request_id`、`status`、`metrics.render`。本特性需在 `metrics.render` 中新增 `clip_stats` 字段，记录总任务数、成功数、失败数、平均耗时、峰值并发等。
- **ClipDownloadTask**：虚拟实体，用于描述单个 `RenderLine` 对应的异步裁剪任务，包含 `clip_task_id`、`video_id`、`start_ms`、`end_ms`、`current_status`、`retry_count`、`started_at`、`finished_at`、`fallback_used` 等属性，用于日志与监控，不需要落库但需贯穿整个裁剪流程。

### 假设

- 并发裁剪只应用于视频片段拉流/截取阶段，后续 concat、上音轨等步骤仍保持串行，以简化实现。
- CDN 端支持同一视频的多并发 HLS 请求，无需额外限流；如未来限制收紧，将通过配置降低并发。
- 渲染任务平均在 70 段以内，本方案以 4～6 并发为目标，不考虑超过 16 并发的极端情况。

## 成功标准（必填）

> 指标需可度量、与技术无关，并能在验收时客观判断通过/未通过。

- **SC-001**：平均单曲渲染总耗时（锁定歌词数 ≥ 50）相较串行版本缩短 ≥ 40%，并在 20 分钟内完成。
- **SC-002**：裁剪阶段的 `clip_task_duration` P95 控制在 45 秒以内，峰值并发不超过配置上限 +1。
- **SC-003**：渲染任务的失败率保持在 2% 以下，且全部失败都在输出报告中被准确标记，运营可在 5 分钟内定位缺失素材。
- **SC-004**：监控面板新增并行裁剪指标后，SRE 能在 1 分钟内获知异常（配置或 CDN 报错），并通过调整配置恢复正常；该能力需在演练中验证。
